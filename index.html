<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>桃園機場｜114實習相簿</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#0b0f14; --fg:#e8f0ff; --brand:#00c2ff; --muted:#9aa4b2;
    --title-size: clamp(16px, 5.5vw, 28px);
    --hint-size:  clamp(11px, 3.6vw, 14px);
    --cap-size:   clamp(13px, 3.8vw, 18px);
    --wm-size:    clamp(12px, 3.5vw, 18px);
    --top-pad: calc(env(safe-area-inset-top, 0px) + 10px);
    --side-pad: calc(env(safe-area-inset-left, 0px) + 12px);
    --trans: 800ms;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg)}
  body{font-family:"Noto Sans TC",system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,"PingFang TC","Microsoft JhengHei",sans-serif}

  .topbar{
    position:fixed;left:0;right:0;top:0;z-index:10;
    padding: var(--top-pad) var(--side-pad) 8px var(--side-pad);
    background: linear-gradient(180deg, rgba(0,0,0,.68), rgba(0,0,0,0));
  }
  .title{
    font-weight:900;font-size:var(--title-size);line-height:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    text-shadow: 0 1px 2px rgba(0,0,0,.35);
  }
  .title b{ color:var(--brand); }
  .hint{
    margin-top:6px;color:var(--muted);font-size:var(--hint-size);line-height:1.2;
    text-shadow: 0 1px 1px rgba(0,0,0,.3);
  }

  /* 狀態指示器（右上角） */
  .status{
    position:fixed; top:var(--top-pad); right:var(--side-pad); z-index:11;
    display:flex; align-items:center; gap:8px; color:var(--muted); font-size:var(--hint-size);
    text-shadow:0 1px 1px rgba(0,0,0,.3);
    user-select:none; pointer-events:none;
  }
  .bars{display:flex; align-items:flex-end; gap:2px; height:12px;}
  .bar{ width:3px; height:10px; background:var(--brand); opacity:.95; transform-origin:bottom; animation:eq 1s ease-in-out infinite; }
  .bar:nth-child(2){animation-delay:.15s}
  .bar:nth-child(3){animation-delay:.30s}
  @keyframes eq{0%,100%{transform:scaleY(.35)}50%{transform:scaleY(1)}}
  .paused .bar{ animation:none; opacity:.35 }
  .status .label{font-weight:700; letter-spacing:.3px}
  .playing .label::before{ content:"▶ 播放中"; }
  .paused  .label::before{ content:"⏸ 已暫停"; }

  /* 舞台區 */
  .stage{position:fixed;inset:0;display:grid;place-items:center}
  .wrap{position:relative;width:100%;height:100%}
  .slide{position:absolute;inset:0;display:grid;place-items:center;opacity:0;transition:opacity var(--trans) ease}
  .slide.show{opacity:1}
  img.photo{max-width:100%;max-height:100%;object-fit:contain;image-rendering:auto}

  /* 左下字幕 */
  .caption{
    position:fixed;left:var(--side-pad);
    bottom:calc(env(safe-area-inset-bottom, 0px) + 10px);
    color:var(--muted);font-size:var(--cap-size);
    text-shadow: 0 1px 2px rgba(0,0,0,.35);
    z-index:10;
  }
  .cap-in{animation:capIn .5s ease both}
  @keyframes capIn{from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)}}

  /* 右下水印（小螢幕自動隱藏） */
  .wm{
    position:fixed;right:var(--side-pad);
    bottom:calc(env(safe-area-inset-bottom, 0px) + 10px);
    color:var(--brand);font-weight:900;font-size:var(--wm-size);z-index:10;
    text-shadow:0 1px 2px rgba(0,0,0,.35);
  }
  @media (max-width: 480px) { .wm{ display:none; } }

  /* 中央瞬間提示（播放/暫停） */
  .toast{
    pointer-events:none; position:fixed; left:50%; top:50%; transform:translate(-50%,-50%) scale(.9);
    background:rgba(0,0,0,.55); color:var(--fg); padding:10px 14px; border-radius:999px; font-weight:900;
    letter-spacing:.5px; opacity:0; z-index:20;
  }
  .toast.show{ animation:toast 900ms ease both; }
  @keyframes toast{
    0%{opacity:0; transform:translate(-50%,-50%) scale(.85)}
    18%{opacity:1; transform:translate(-50%,-50%) scale(1)}
    82%{opacity:1}
    100%{opacity:0; transform:translate(-50%,-50%) scale(1.05)}
  }

  @media (prefers-reduced-motion: reduce) {
    .slide { transition: none !important; }
    .cap-in { animation: none !important; }
    .bars .bar{ animation:none !important; }
    .toast.show{ animation:none !important; opacity:1; }
  }
</style>
</head>
<body>
  <div class="topbar">
    <div class="title">桃園機場 <b>TIAC</b>｜114實習相簿</div>
    <div class="hint">左右滑動：上一張／下一張　·　點一下：暫停／播放</div>
  </div>

  <!-- 播放狀態指示器 -->
  <div id="status" class="status playing">
    <div class="bars"><div class="bar"></div><div class="bar"></div><div class="bar"></div></div>
    <span class="label"></span>
  </div>

  <div class="stage"><div class="wrap" id="wrap">
    <div class="slide" id="s0"><img class="photo" alt=""></div>
    <div class="slide" id="s1"><img class="photo" alt=""></div>
  </div></div>

  <div class="caption" id="cap"></div>
  <div class="wm" id="wm">= 2025 SUMMER =</div>
  <div class="toast" id="toast"></div>

<script>
/* 參數 */
const MAX_SCAN = 200;
const EXTS = ['jpg','jpeg','png','webp','JPG','JPEG','PNG','WEBP'];
const INTERVAL_MS = 3600;
const TRANSITION_MS = 800;
const TYPE_MS_PER_CHAR = 18;
const USE_PHOTOS_TXT = true;

/* 工具 */
const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
function preloadOk(url){
  return new Promise(res=>{
    const img = new Image();
    img.onload = ()=>res(true);
    img.onerror = ()=>res(false);
    img.src = url + (url.includes('?')?'&':'?') + 't=' + Date.now();
  });
}

/* photos.txt */
async function listFromTxt(){
  try{
    const r = await fetch('photos/photos.txt',{cache:'no-store'});
    if(!r.ok) return [];
    const raw = (await r.text()).replace(/^\uFEFF/,'');
    const rows = raw.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    const list = rows.map(line=>{
      const [nameRaw, ...rest] = line.split('|');
      const name = (nameRaw||'').replace(/^\uFEFF/,'').trim();
      const titleRaw = rest.join('|').trim();
      const src = `photos/${name}`;
      const title = (titleRaw || name).replace(/\.(jpe?g|png|webp)$/i,'');
      return {src, title};
    });
    const ok = [];
    for(const it of list){ if(await preloadOk(it.src)) ok.push(it); }
    return ok;
  }catch{ return []; }
}

/* 連號掃描（不中斷） */
async function listFromScan(){
  const out=[];
  for(let i=1;i<=MAX_SCAN;i++){
    const num = String(i).padStart(3,'0');
    let hit=null;
    for(const ext of EXTS){
      const url = `photos/${num}.${ext}`;
      if(await preloadOk(url)){ hit=url; break; }
    }
    if(hit){ out.push({src:hit, title:num}); }
  }
  return out;
}
async function getPhotos(){
  if(USE_PHOTOS_TXT){
    const a = await listFromTxt();
    if(a.length) return a;
  }
  return await listFromScan();
}

/* 字幕動畫 */
let capToken = 0;
function setCaption(idx, title){
  const cap = document.getElementById('cap');
  const n = String(idx+1).padStart(3,'0');
  const text = `${n}｜${title||''}`;
  cap.classList.remove('cap-in'); void cap.offsetWidth; cap.classList.add('cap-in');
  const my = ++capToken; cap.textContent=''; let i=0;
  (function step(){ if(my!==capToken) return;
    cap.textContent = text.slice(0, i++); if(i<=text.length) setTimeout(step, TYPE_MS_PER_CHAR);
  })();
}

/* 狀態 UI */
const statusEl = document.getElementById('status');
const toastEl  = document.getElementById('toast');
function updateStatus(playing){
  statusEl.classList.toggle('playing', playing);
  statusEl.classList.toggle('paused',  !playing);
}
function flashToast(text){
  toastEl.textContent = text;
  toastEl.classList.remove('show'); void toastEl.offsetWidth; // restart
  toastEl.classList.add('show');
  setTimeout(()=>toastEl.classList.remove('show'), 900);
}

(async function main(){
  const photos = await getPhotos();
  if(!photos.length){
    document.body.innerHTML = "<div style='color:#fff;padding:calc(var(--top-pad) + 40px) var(--side-pad)'>找不到任何照片（請在 <code>photos/</code> 放 001.jpg、002.jpg… 或在 <code>photos/photos.txt</code> 每行寫 <code>檔名|字幕</code>）</div>";
    return;
  }

  const s0 = document.getElementById('s0'), s1 = document.getElementById('s1');
  s0.style.setProperty('--trans', TRANSITION_MS+'ms');
  s1.style.setProperty('--trans', TRANSITION_MS+'ms');

  let cur=0, showA=true, playing=true;

  async function show(idx){
    const ph = photos[idx];
    const target = showA ? s1 : s0;
    const img = target.querySelector('img');

    if(!(await preloadOk(ph.src))){
      cur = (cur+1)%photos.length;
      await show(cur);
      return;
    }
    img.src = ph.src;
    setCaption(idx, ph.title);

    (showA ? s0 : s1).classList.remove('show');
    target.classList.add('show');
    showA = !showA;

    const nextIdx = (idx+1)%photos.length;
    preloadOk(photos[nextIdx].src);
  }
  function next(){ cur = (cur+1)%photos.length; show(cur); }
  function prev(){ cur = (cur-1+photos.length)%photos.length; show(cur); }

  await show(0);
  let timerId = setInterval(next, INTERVAL_MS);
  updateStatus(true);

  function play(p){
    playing = p;
    clearInterval(timerId);
    if(playing) timerId = setInterval(next, INTERVAL_MS);
    updateStatus(playing);
  }

  /* 點一下：暫停／播放（防滑動後幽靈點擊） */
  let suppressClickUntil = 0;
  document.addEventListener('click', () => {
    if (Date.now() < suppressClickUntil) return;
    play(!playing);
    flashToast(playing ? "▶ 播放" : "⏸ 暫停");
  });

  /* 左右滑動切換，並抑制滑動後的 click */
  let touchX = null;
  document.addEventListener('touchstart', e => { touchX = e.touches[0].clientX; }, {passive:true});
  document.addEventListener('touchend',   e => {
    if (touchX == null) return;
    const dx = e.changedTouches[0].clientX - touchX;
    touchX = null;
    if (Math.abs(dx) > 40) {
      (dx < 0 ? next() : prev());
      suppressClickUntil = Date.now() + 350;
    }
  }, {passive:true});

  /* 桌面鍵盤 */
  document.addEventListener('keydown', e=>{
    if(e.code==='Space'){ e.preventDefault(); play(!playing); flashToast(playing ? "▶ 播放" : "⏸ 暫停"); }
    else if(e.key==='ArrowRight'){ next(); }
    else if(e.key==='ArrowLeft'){  prev(); }
  });
})();
</script>
</body>
</html>
