<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>桃園機場｜實習相簿</title>

<!-- 字體：Noto Sans TC -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#0b0f14; --fg:#e8f0ff; --brand:#00c2ff; --muted:#94a3b8;
    --brand-size:22px; --hint-size:13px; --cap-size:20px; --wm-size:18px;
    --trans:800ms;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg)}
  body{font-family:"Noto Sans TC",system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,"PingFang TC","Microsoft JhengHei",sans-serif}

  .chrome{position:fixed;inset:0 0 auto 0;height:56px;display:flex;align-items:center;justify-content:space-between;
          padding:0 18px;background:linear-gradient(180deg,rgba(0,0,0,.6),rgba(0,0,0,0));z-index:10}
  .brand{font-weight:900;letter-spacing:.4px;font-size:var(--brand-size)}
  .brand b{color:var(--brand)}
  .hint{color:#9aa4b2;font-size:var(--hint-size)}

  .stage{position:fixed;inset:0;display:grid;place-items:center}
  .wrap{position:relative;width:100%;height:100%}
  .slide{position:absolute;inset:0;display:grid;place-items:center;opacity:0;transition:opacity var(--trans) ease}
  .slide.show{opacity:1}
  img.photo{max-width:100%;max-height:100%;object-fit:contain;image-rendering:auto}

  .caption{position:fixed;left:16px;bottom:14px;color:var(--muted);font-size:var(--cap-size)}
  .wm{position:fixed;right:16px;bottom:12px;color:var(--brand);font-weight:900;font-size:var(--wm-size)}
  .cap-in{animation:capIn .5s ease both}
  @keyframes capIn{from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)}}
</style>
</head>
<body>
  <div class="chrome">
    <div class="brand" id="brandL">桃園機場 <b>TIAC</b>｜實習相簿</div>
    <div class="hint"  id="hint">點擊/空白鍵：暫停‧繼續　←/→：上一張/下一張</div>
  </div>

  <div class="stage"><div class="wrap" id="wrap">
    <div class="slide" id="s0"><img class="photo" /></div>
    <div class="slide" id="s1"><img class="photo" /></div>
  </div></div>

  <div class="caption" id="cap"></div>
  <div class="wm" id="wm">= 2025 SUMMER =</div>

<script>
/* 參數 */
const MAX_SCAN = 200;
const EXTS = ['jpg','jpeg','png','webp'];
const INTERVAL_MS = 3600;
const TRANSITION_MS = 800;
const TYPE_MS_PER_CHAR = 18;
const USE_PHOTOS_TXT = true;

/* 工具 */
const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
function preloadOk(url){
  return new Promise(res=>{
    const img = new Image();
    img.onload = ()=>res(true);
    img.onerror = ()=>res(false);
    img.src = url + (url.includes('?')?'&':'?') + 't=' + Date.now(); // 防快取
  });
}

/* 讀 photos.txt（容錯：trim、BOM、允許 "檔名 | 標題"）*/
async function listFromTxt(){
  try{
    const r = await fetch('photos/photos.txt',{cache:'no-store'});
    if(!r.ok) return [];
    const raw = (await r.text()).replace(/^\uFEFF/,'');
    const rows = raw.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    const list = rows.map(line=>{
      const [nameRaw, ...rest] = line.split('|');
      const name = (nameRaw||'').replace(/^\uFEFF/,'').trim();
      const titleRaw = rest.join('|').trim(); // 允許標題含 |
      const src = `photos/${name}`;
      const title = (titleRaw || name).replace(/\.(jpe?g|png|webp)$/i,'');
      return {src, title};
    });
    // 驗證實際可載入
    const ok = [];
    for(const it of list){
      if(await preloadOk(it.src)) ok.push(it);
    }
    return ok;
  }catch{ return []; }
}

/* 連號掃描後再驗證 */
async function listFromScan(){
  const out=[];
  for(let i=1;i<=MAX_SCAN;i++){
    const num = String(i).padStart(3,'0');
    let hit=null;
    for(const ext of EXTS){
      const url = `photos/${num}.${ext}`;
      if(await preloadOk(url)){ hit=url; break; }
    }
    if(!hit) break;
    out.push({src:hit, title:num});
  }
  return out;
}

/* 取得清單：先 txt → 全空才掃描 */
async function getPhotos(){
  if(USE_PHOTOS_TXT){
    const a = await listFromTxt();
    if(a.length) return a;
  }
  return await listFromScan();
}

/* 字幕（001｜標題）＋打字動畫 */
let capToken = 0;
function setCaption(idx, title){
  const cap = document.getElementById('cap');
  const n = String(idx+1).padStart(3,'0');
  const text = `${n}｜${title||''}`;
  cap.classList.remove('cap-in'); void cap.offsetWidth; cap.classList.add('cap-in');
  const my = ++capToken; cap.textContent=''; let i=0;
  (function step(){ if(my!==capToken) return;
    cap.textContent = text.slice(0, i++); if(i<=text.length) setTimeout(step, TYPE_MS_PER_CHAR);
  })();
}

(async function main(){
  const photos = await getPhotos();
  if(!photos.length){
    document.body.innerHTML = "<div style='color:#fff;padding:32px'>找不到任何照片（請在 <code>photos/</code> 放 001.jpg、002.jpg… 或在 <code>photos/photos.txt</code> 每行寫 <code>檔名|字幕</code>）</div>";
    return;
  }

  const s0 = document.getElementById('s0'), s1 = document.getElementById('s1');
  s0.style.setProperty('--trans', TRANSITION_MS+'ms');
  s1.style.setProperty('--trans', TRANSITION_MS+'ms');

  let cur=0, showA=true, playing=true, timer=null;

  async function show(idx){
    const ph = photos[idx];
    const target = showA ? s1 : s0;
    const img = target.querySelector('img');

    // 單張容錯：載入失敗就跳下一張
    if(!(await preloadOk(ph.src))){
      cur = (cur+1)%photos.length;
      await show(cur);
      return;
    }
    img.src = ph.src;
    setCaption(idx, ph.title);

    (showA ? s0 : s1).classList.remove('show');
    target.classList.add('show');
    showA = !showA;

    // 預載下一張（不阻塞）
    const nextIdx = (idx+1)%photos.length;
    preloadOk(photos[nextIdx].src);
  }

  function next(){ cur = (cur+1)%photos.length; show(cur); }
  function prev(){ cur = (cur-1+photos.length)%photos.length; show(cur); }

  await show(0);
  timer = setInterval(next, INTERVAL_MS);

  function play(p){ playing=p; if(playing){ timer=setInterval(next,INTERVAL_MS);} else{ clearInterval(timer);} }
  document.addEventListener('click', ()=>play(!playing));
  document.addEventListener('keydown', e=>{
    if(e.code==='Space'){ e.preventDefault(); play(!playing); }
    else if(e.key==='ArrowRight'){ next(); }
    else if(e.key==='ArrowLeft'){ prev(); }
  });
})();
</script>
</body>
</html>
